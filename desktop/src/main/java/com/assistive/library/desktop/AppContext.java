package com.assistive.library.desktop;

import com.assistive.library.desktop.api.ApiClient;
import com.assistive.library.desktop.api.AuthApi;
import com.assistive.library.desktop.api.LookupApi;
import com.assistive.library.desktop.api.PolicyApi;
import com.assistive.library.desktop.api.SettingsApi;
import com.assistive.library.desktop.api.SyncApi;
import com.assistive.library.desktop.api.UsersApi;
import com.assistive.library.desktop.data.BookDao;
import com.assistive.library.desktop.data.LoanDao;
import com.assistive.library.desktop.data.MemberDao;
import com.assistive.library.desktop.data.SettingsDao;
import com.assistive.library.desktop.data.SyncQueueDao;
import com.assistive.library.desktop.state.SessionState;
import com.assistive.library.desktop.sync.SyncManager;

public class AppContext {
  private final ApiClient apiClient;
  private final AuthApi authApi;
  private final UsersApi usersApi;
  private final SettingsApi settingsApi;
  private final PolicyApi policyApi;
  private final SyncApi syncApi;
  private final LookupApi lookupApi;
  private final SessionState sessionState;
  private final BookDao bookDao;
  private final MemberDao memberDao;
  private final LoanDao loanDao;
  private final SettingsDao settingsDao;
  private final SyncQueueDao syncQueueDao;
  private final SyncManager syncManager;

  public AppContext(ApiClient apiClient) {
    this.apiClient = apiClient;
    this.authApi = new AuthApi(apiClient);
    this.usersApi = new UsersApi(apiClient);
    this.settingsApi = new SettingsApi(apiClient);
    this.policyApi = new PolicyApi(apiClient);
    this.syncApi = new SyncApi(apiClient);
    this.lookupApi = new LookupApi(apiClient);
    this.sessionState = new SessionState();
    this.bookDao = new BookDao();
    this.memberDao = new MemberDao();
    this.loanDao = new LoanDao();
    this.settingsDao = new SettingsDao();
    this.syncQueueDao = new SyncQueueDao();
    this.syncManager = new SyncManager(syncApi, policyApi, syncQueueDao, bookDao, memberDao, loanDao, settingsDao);
    ensureLocalDefaults();
  }

  public ApiClient getApiClient() {
    return apiClient;
  }

  public AuthApi getAuthApi() {
    return authApi;
  }

  public UsersApi getUsersApi() {
    return usersApi;
  }

  public SettingsApi getSettingsApi() {
    return settingsApi;
  }

  public PolicyApi getPolicyApi() {
    return policyApi;
  }

  public SyncApi getSyncApi() {
    return syncApi;
  }

  public LookupApi getLookupApi() {
    return lookupApi;
  }

  public SessionState getSessionState() {
    return sessionState;
  }

  public BookDao getBookDao() {
    return bookDao;
  }

  public MemberDao getMemberDao() {
    return memberDao;
  }

  public LoanDao getLoanDao() {
    return loanDao;
  }

  public SettingsDao getSettingsDao() {
    return settingsDao;
  }

  public SyncQueueDao getSyncQueueDao() {
    return syncQueueDao;
  }

  public SyncManager getSyncManager() {
    return syncManager;
  }

  private void ensureLocalDefaults() {
    if (settingsDao.getValue("loan.dueDays") == null) {
      settingsDao.setValue("loan.dueDays", "14");
    }
    if (settingsDao.getValue("loan.finePerDay") == null) {
      settingsDao.setValue("loan.finePerDay", "1.0");
    }
    if (settingsDao.getValue("loan.maxActive") == null) {
      settingsDao.setValue("loan.maxActive", "5");
    }
    if (settingsDao.getValue("school.name") == null) {
      settingsDao.setValue("school.name", "School Library");
    }
    if (settingsDao.getValue("school.logoPath") == null) {
      settingsDao.setValue("school.logoPath", "");
    }
    if (settingsDao.getValue("school.footer") == null) {
      settingsDao.setValue("school.footer", "Generated by EduShelf");
    }
    if (settingsDao.getValue("ai.ollama.baseUrl") == null) {
      settingsDao.setValue("ai.ollama.baseUrl", "http://localhost:11434");
    }
    if (settingsDao.getValue("ai.ollama.model") == null) {
      settingsDao.setValue("ai.ollama.model", "");
    }
  }
}
