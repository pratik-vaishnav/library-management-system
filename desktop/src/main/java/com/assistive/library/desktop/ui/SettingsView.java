package com.assistive.library.desktop.ui;

import com.assistive.library.desktop.AppContext;
import com.assistive.library.desktop.api.SettingItem;
import javafx.concurrent.Task;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.control.CheckBox;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;

public class SettingsView extends VBox {
  public SettingsView(AppContext context) {
    setPadding(new Insets(16, 0, 0, 0));
    setSpacing(16);

    Label title = new Label("Settings");
    title.getStyleClass().add("section-title");

    TextField schoolNameField = new TextField(getLocalSetting(context, "school.name", "School Library"));
    TextField logoPathField = new TextField(getLocalSetting(context, "school.logoPath", ""));
    TextField footerField = new TextField(getLocalSetting(context, "school.footer", "Generated by EduShelf"));
    TextField dueDaysField = new TextField(getLocalSetting(context, "loan.dueDays", "14"));
    TextField fineField = new TextField(getLocalSetting(context, "loan.finePerDay", "1.0"));
    TextField maxActiveField = new TextField(getLocalSetting(context, "loan.maxActive", "5"));
    TextField aiBaseUrlField = new TextField(getLocalSetting(context, "ai.ollama.baseUrl", "http://localhost:11434"));
    TextField aiModelField = new TextField(getLocalSetting(context, "ai.ollama.model", ""));
    CheckBox reduceMotionBox = new CheckBox();
    reduceMotionBox.setSelected(Boolean.parseBoolean(getLocalSetting(context, "ui.reduceMotion", "false")));

    GridPane form = new GridPane();
    form.setHgap(12);
    form.setVgap(12);
    form.add(new Label("School Name"), 0, 0);
    form.add(schoolNameField, 1, 0);
    form.add(new Label("Logo Path"), 0, 1);
    form.add(logoPathField, 1, 1);
    form.add(new Label("Footer Text"), 0, 2);
    form.add(footerField, 1, 2);
    form.add(new Label("Due Days"), 0, 3);
    form.add(dueDaysField, 1, 3);
    form.add(new Label("Fine per Day"), 0, 4);
    form.add(fineField, 1, 4);
    form.add(new Label("Max Active Loans"), 0, 5);
    form.add(maxActiveField, 1, 5);
    form.add(new Label("Ollama Base URL"), 0, 6);
    form.add(aiBaseUrlField, 1, 6);
    form.add(new Label("Ollama Model"), 0, 7);
    form.add(aiModelField, 1, 7);
    form.add(new Label("Reduce Motion"), 0, 8);
    form.add(reduceMotionBox, 1, 8);

    Label status = new Label();
    status.getStyleClass().add("muted");

    Button saveLocal = new Button("Save Locally");
    saveLocal.getStyleClass().add("primary-button");
    saveLocal.setOnAction(event -> {
      context.getSettingsDao().setValue("school.name", schoolNameField.getText().trim());
      context.getSettingsDao().setValue("school.logoPath", logoPathField.getText().trim());
      context.getSettingsDao().setValue("school.footer", footerField.getText().trim());
      context.getSettingsDao().setValue("loan.dueDays", dueDaysField.getText().trim());
      context.getSettingsDao().setValue("loan.finePerDay", fineField.getText().trim());
      context.getSettingsDao().setValue("loan.maxActive", maxActiveField.getText().trim());
      context.getSettingsDao().setValue("ai.ollama.baseUrl", aiBaseUrlField.getText().trim());
      context.getSettingsDao().setValue("ai.ollama.model", aiModelField.getText().trim());
      context.getSettingsDao().setValue("ui.reduceMotion", Boolean.toString(reduceMotionBox.isSelected()));
      status.setText("Saved locally.");
    });

    Button pushServer = new Button("Push to Server");
    pushServer.setOnAction(event -> pushToServer(context, schoolNameField, logoPathField, footerField,
        dueDaysField, fineField, maxActiveField, status));

    HBox actions = new HBox(12, saveLocal, pushServer, status);
    actions.setAlignment(Pos.CENTER_LEFT);

    getChildren().addAll(title, form, actions);
  }

  private String getLocalSetting(AppContext context, String key, String fallback) {
    String value = context.getSettingsDao().getValue(key);
    return value == null ? fallback : value;
  }

  private void pushToServer(AppContext context,
                            TextField schoolNameField,
                            TextField logoPathField,
                            TextField footerField,
                            TextField dueDaysField,
                            TextField fineField,
                            TextField maxActiveField,
                            Label status) {
    status.setText("Saving to server...");
    Task<SettingItem[]> task = new Task<>() {
      @Override
      protected SettingItem[] call() throws Exception {
        SettingItem school = new SettingItem();
        school.setKey("school.name");
        school.setValue(schoolNameField.getText().trim());
        SettingItem logo = new SettingItem();
        logo.setKey("school.logoPath");
        logo.setValue(logoPathField.getText().trim());
        SettingItem footer = new SettingItem();
        footer.setKey("school.footer");
        footer.setValue(footerField.getText().trim());
        SettingItem due = new SettingItem();
        due.setKey("loan.dueDays");
        due.setValue(dueDaysField.getText().trim());
        SettingItem fine = new SettingItem();
        fine.setKey("loan.finePerDay");
        fine.setValue(fineField.getText().trim());
        SettingItem maxActive = new SettingItem();
        maxActive.setKey("loan.maxActive");
        maxActive.setValue(maxActiveField.getText().trim());
        return context.getSettingsApi().updateSettings(new SettingItem[] { school, logo, footer, due, fine, maxActive });
      }
    };

    task.setOnSucceeded(event -> status.setText("Server updated."));
    task.setOnFailed(event -> status.setText("Failed to update server."));

    Thread thread = new Thread(task);
    thread.setDaemon(true);
    thread.start();
  }
}
